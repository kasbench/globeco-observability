apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel-collector-daemonset
  namespace: monitoring
spec:
  mode: daemonset
  image: otel/opentelemetry-collector-contrib:latest
  serviceAccount: otel-collector-daemonset

  # Pod Annotations for Prometheus autodiscovery
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8889"
    prometheus.io/path: "/metrics"

  env:
    - name: MY_POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: MY_POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: MY_NODE_NAME
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: spec.nodeName
    - name: MY_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace


  # Ports configuration
  ports:
    - name: otlp-grpc
      port: 4317
      hostPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      hostPort: 4318
      protocol: TCP
    - name: prometheus
      port: 8889
      hostPort: 8889
      protocol: TCP
    - name: pprof
      port: 1777
      targetPort: 1777
      protocol: TCP
    - name: zpages
      port: 55679
      targetPort: 55679
      protocol: TCP

  # Collector configuration
  config:
    receivers:
      hostmetrics:
        collection_interval: 30s
        scrapers:
          cpu: {}
          disk: {}
          load: {}
          filesystem: {}
          memory: {}
          network: {}
          paging: {}
          process:
            mute_process_name_error: true
            mute_process_exe_error: true
            mute_process_io_error: true
          processes: {}
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins: ["http://*", "https://*"]

      # keep your DB and service receivers
      postgresql/trade:
        endpoint: globeco-trade-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases: [postgres]
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      
      # ... keep the rest of your postgresql/*, mongodb/*, redis/*, kafkametrics/* receivers unchanged ...
      postgresql/trade_all:
        endpoint: globeco-trade-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/allocation:
        endpoint: globeco-allocation-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/allocation_all:
        endpoint: globeco-allocation-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/order:
        endpoint: globeco-order-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/order_all:
        endpoint: globeco-order-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/pricing:
        endpoint: globeco-pricing-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/pricing_all:
        endpoint: globeco-pricing-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/execution:
        endpoint: globeco-execution-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/execution_all:
        endpoint: globeco-execution-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/fix:
        endpoint: globeco-fix-engine-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/fix_all:
        endpoint: globeco-fix-engine-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/portfolio_accounting:
        endpoint: globeco-portfolio-accounting-service-postgresql.globeco.svc.cluster.local:5432
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      postgresql/portfolio_accounting_all:
        endpoint: globeco-portfolio-accounting-service-postgresql.globeco.svc.cluster.local:5432
        transport: tcp
        username: postgres
        password: none
        databases:
          - postgres
        collection_interval: 10s
        tls:
          insecure: true
          insecure_skip_verify: true
      # mongodb/order_generation:
      #  hosts:
      #   - endpoint: globeco-order-generation-service-mongodb.globeco.svc.cluster.local:27017
      #  collection_interval: 30s
      #  initial_delay: 1s
      #  tls:
      #    insecure: true
      #    insecure_skip_verify: true
      #  metrics:
      #    mongodb.uptime:
      #      enabled: true
      #    mongodb.commands.rate:
      #      enabled: true
      #    mongodb.health:
      #      enabled: true
      #    mongodb.operation.latency.time:
      #      enabled: true
      #    mongodb.queries.rate:
      #      enabled: true
      mongodb/portfolio:
       hosts:
        - endpoint: globeco-portfolio-service-mongodb.globeco.svc.cluster.local:27017
       collection_interval: 30s
       initial_delay: 1s
       tls:
         insecure: true
         insecure_skip_verify: true
       metrics:
         mongodb.uptime:
           enabled: true
         mongodb.commands.rate:
           enabled: true
         mongodb.health:
           enabled: true
         mongodb.operation.latency.time:
           enabled: true
         mongodb.queries.rate:
           enabled: true
      mongodb/security:
       hosts:
        - endpoint: globeco-security-service-mongodb.globeco.svc.cluster.local:27017
       collection_interval: 30s
       initial_delay: 1s
       tls:
         insecure: true
         insecure_skip_verify: true
       metrics:
         mongodb.uptime:
           enabled: true
         mongodb.commands.rate:
           enabled: true
         mongodb.health:
           enabled: true
         mongodb.operation.latency.time:
           enabled: true
         mongodb.queries.rate:
           enabled: true
      redis/order_generation:
        endpoint: "globeco-order-generation-service-redis.globeco.svc.cluster.local:6379"
        collection_interval: 10s
        tls:
          insecure: true
      redis/portfolio_accounting:
        endpoint: "globeco-portfolio-accounting-service-redis.globeco.svc.cluster.local:6379"
        collection_interval: 10s
        tls:
          insecure: true
      kafkametrics/execution_service:
        cluster_alias: kafka-execution-service
        brokers: ["globeco-execution-service-kafka.globeco.svc.cluster.local:9092"]
        protocol_version: 3.0.0
        scrapers:
          - brokers
          - topics
          - consumers
        collection_interval: 30s
    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
        send_batch_max_size: 2048
      memory_limiter:
        limit_mib: 512
        spike_limit_mib: 128
        check_interval: 5s
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        wait_for_metadata: true
        filter:
          node_from_env_var: MY_NODE_NAME
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
            - k8s.deployment.name
            - k8s.daemonset.name
            - k8s.statefulset.name
            - k8s.job.name
            - k8s.container.name
            - container.image.name
            - container.id
            - container.image.tag
            # - k8s.pod.ip
          labels:
            - tag_name: k8s.pod.label.app
              key: app
              from: pod
            - tag_name: k8s.pod.label.version
              key: version
              from: pod
        
        pod_association: # How to associate the data to a pod (order matters)
          - sources: # First try to use the value of the resource attribute k8s.pod.ip
              - from: resource_attribute
                name: k8s.pod.ip
          - sources: # Then try to use the value of the resource attribute k8s.pod.uid
              - from: resource_attribute
                name: k8s.pod.uid
          - sources: # If neither of those work, use the request's connection to get the pod IP.
              - from: connection
        
        # pod_association:
          
        #   - sources:
        #     - from: connection

        #   # 1. Try explicit resource attributes (if set by apps) - THIS SHOULD BE FIRST
        #   - sources:
        #     - from: resource_attribute
        #       name: k8s.pod.ip
        #     - from: resource_attribute
        #       name: k8s.pod.name
          
          

        #   # 2. Try connection-based (fallback for when resource_attribute is not set)
        #   - sources:
        #       - from: connection
          
        #   # 3. Try service.name based association (fallback)
        #   - sources:
        #       - from: resource_attribute
        #         name: service.name
        #       - from: resource_attribute  
        #         name: k8s.namespace.name
          
        #   # 4. Try pod name + namespace (if available)
        #   - sources:
        #       - from: resource_attribute
        #         name: k8s.pod.name
        #       - from: resource_attribute
        #         name: k8s.namespace.name
         
      resource:
        attributes:
          - key: collector.type
            value: daemonset
            action: upsert
      
      # Separate resource processors for each PostgreSQL instance
      resource/postgres_trade:
        attributes:
          - key: instance_name
            value: globeco-trade-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-trade-service-postgresql
            action: upsert
      
      resource/postgres_trade_all:
        attributes:
          - key: instance_name
            value: globeco-trade-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-trade-service-postgresql
            action: upsert
      
      resource/postgres_allocation:
        attributes:
          - key: instance_name
            value: globeco-allocation-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-allocation-service-postgresql
            action: upsert
      
      resource/postgres_allocation_all:
        attributes:
          - key: instance_name
            value: globeco-allocation-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-allocation-service-postgresql
            action: upsert
      
      resource/postgres_order:
        attributes:
          - key: instance_name
            value: globeco-order-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-order-service-postgresql
            action: upsert
      
      resource/postgres_order_all:
        attributes:
          - key: instance_name
            value: globeco-order-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-order-service-postgresql
            action: upsert
      
      resource/postgres_pricing:
        attributes:
          - key: instance_name
            value: globeco-pricing-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-pricing-service-postgresql
            action: upsert
      
      resource/postgres_pricing_all:
        attributes:
          - key: instance_name
            value: globeco-pricing-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-pricing-service-postgresql
            action: upsert
      
      resource/postgres_execution:
        attributes:
          - key: instance_name
            value: globeco-execution-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-execution-service-postgresql
            action: upsert
      
      resource/postgres_execution_all:
        attributes:
          - key: instance_name
            value: globeco-execution-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-execution-service-postgresql
            action: upsert
      
      resource/postgres_fix:
        attributes:
          - key: instance_name
            value: globeco-fix-engine-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-fix-engine-postgresql
            action: upsert
      
      resource/postgres_fix_all:
        attributes:
          - key: instance_name
            value: globeco-fix-engine-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-fix-engine-postgresql
            action: upsert
      
      resource/postgres_portfolio_accounting:
        attributes:
          - key: instance_name
            value: globeco-portfolio-accounting-service-postgresql
            action: upsert
          - key: postgres_type
            value: main
            action: upsert
          - key: service_name
            value: globeco-portfolio-accounting-service-postgresql
            action: upsert
      
      resource/postgres_portfolio_accounting_all:
        attributes:
          - key: instance_name
            value: globeco-portfolio-accounting-service-postgresql-all
            action: upsert
          - key: postgres_type
            value: monitoring
            action: upsert
          - key: service_name
            value: globeco-portfolio-accounting-service-postgresql
            action: upsert
      
      # resource/mongodb_order_generation:
      #   attributes:
      #     - key: instance_name
      #       value: globeco-order-generation-service-mongodb
      #       action: upsert
      #     - key: service_name
      #       value: globeco-order-generation-service-mongodb
      #       action: upsert
      
      resource/mongodb_portfolio:
        attributes:
          - key: instance_name
            value: globeco-portfolio-service-mongodb
            action: upsert
          - key: service_name
            value: globeco-portfolio-service-mongodb
            action: upsert
      
      resource/mongodb_security:
        attributes:
          - key: instance_name
            value: globeco-security-service-mongodb
            action: upsert
          - key: service_name
            value: globeco-security-service-mongodb
            action: upsert
      
      resource/redis_order_generation:
        attributes:
          - key: instance_name
            value: globeco-order-generation-service-redis
            action: upsert
          - key: service_name
            value: globeco-order-generation-service-redis
            action: upsert
      
      resource/redis_portfolio_accounting:
        attributes:
          - key: instance_name
            value: globeco-portfolio-accounting-service-redis
            action: upsert
          - key: service_name
            value: globeco-portfolio-accounting-service-redis
            action: upsert
      
      resource/kafkametrics_execution:
        attributes:
          - key: instance_name
            value: globeco-execution-service-kafka
            action: upsert
          - key: service_name
            value: globeco-execution-service-kafka
            action: upsert

    exporters:
      prometheus:
        endpoint: "0.0.0.0:8889"
        namespace: ""
        const_labels:
          environment: "production"
          collector: "otel-collector-daemonset"
        metric_expiration: 5m
        resource_to_telemetry_conversion:
          enabled: true
        enable_open_metrics: true
        add_metric_suffixes: true

      otlp:
        endpoint: "jaeger.observability.svc.cluster.local:4317"
        tls:
          insecure: true
      debug: 
        verbosity: detailed

    extensions:
      pprof:
        endpoint: 0.0.0.0:1777
      zpages:
        endpoint: 0.0.0.0:55679

    service:
      extensions: [pprof, zpages]
      pipelines:
        metrics/host:
          receivers: [hostmetrics]
          processors: [memory_limiter, resource, batch]
          exporters: [prometheus]
        
        metrics/applications:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, resource, batch]
          exporters: [prometheus]

        # metrics/services:
        #   receivers: [otlp, hostmetrics]
        #   processors: [memory_limiter, k8sattributes, resource, batch]
        #   exporters: [prometheus, debug]
        
        
        
        # keep your DB/Mongo/Redis/Kafka pipelines as-is, each mapped to the right resource processor
        
        # Separate pipelines for Trade Service PostgreSQL instances
        metrics/postgres_trade:
          receivers: [postgresql/trade]
          processors: [memory_limiter, resource/postgres_trade, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_trade_all:
          receivers: [postgresql/trade_all]
          processors: [memory_limiter, resource/postgres_trade_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Allocation Service PostgreSQL instances
        metrics/postgres_allocation:
          receivers: [postgresql/allocation]
          processors: [memory_limiter, resource/postgres_allocation, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_allocation_all:
          receivers: [postgresql/allocation_all]
          processors: [memory_limiter, resource/postgres_allocation_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Order Service PostgreSQL instances
        metrics/postgres_order:
          receivers: [postgresql/order]
          processors: [memory_limiter, resource/postgres_order, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_order_all:
          receivers: [postgresql/order_all]
          processors: [memory_limiter, resource/postgres_order_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Pricing Service PostgreSQL instances
        metrics/postgres_pricing:
          receivers: [postgresql/pricing]
          processors: [memory_limiter, resource/postgres_pricing, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_pricing_all:
          receivers: [postgresql/pricing_all]
          processors: [memory_limiter, resource/postgres_pricing_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Execution Service PostgreSQL instances
        metrics/postgres_execution:
          receivers: [postgresql/execution]
          processors: [memory_limiter, resource/postgres_execution, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_execution_all:
          receivers: [postgresql/execution_all]
          processors: [memory_limiter, resource/postgres_execution_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Fix Engine PostgreSQL instances
        metrics/postgres_fix:
          receivers: [postgresql/fix]
          processors: [memory_limiter, resource/postgres_fix, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_fix_all:
          receivers: [postgresql/fix_all]
          processors: [memory_limiter, resource/postgres_fix_all, batch]
          exporters: [prometheus, debug]
        
        # Separate pipelines for Portfolio Accounting Service PostgreSQL instances
        metrics/postgres_portfolio_accounting:
          receivers: [postgresql/portfolio_accounting]
          processors: [memory_limiter, resource/postgres_portfolio_accounting, batch]
          exporters: [prometheus, debug]
        
        metrics/postgres_portfolio_accounting_all:
          receivers: [postgresql/portfolio_accounting_all]
          processors: [memory_limiter, resource/postgres_portfolio_accounting_all, batch]
          exporters: [prometheus, debug]
        
        # metrics/mongodb_order_generation:
        #   receivers: [mongodb/order_generation]
        #   processors: [memory_limiter, resource/mongodb_order_generation, batch]
        #   exporters: [prometheus, debug]
        
        metrics/mongodb_portfolio:
          receivers: [mongodb/portfolio]
          processors: [memory_limiter, resource/mongodb_portfolio, batch]
          exporters: [prometheus, debug]
        
        metrics/mongodb_security:
          receivers: [mongodb/security]
          processors: [memory_limiter, resource/mongodb_security, batch]
          exporters: [prometheus, debug]
        
        metrics/redis_order_generation:
          receivers: [redis/order_generation]
          processors: [memory_limiter, resource/redis_order_generation, batch]
          exporters: [prometheus, debug]
        
        metrics/redis_portfolio_accounting:
          receivers: [redis/portfolio_accounting]
          processors: [memory_limiter, resource/redis_portfolio_accounting, batch]
          exporters: [prometheus, debug]
        
        metrics/kafkametrics_execution_service:
          receivers: [kafkametrics/execution_service]
          processors: [memory_limiter, resource/kafkametrics_execution, batch]
          exporters: [prometheus, debug]
        
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, resource, batch]
          exporters: [otlp]

        logs:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, resource, batch]
          exporters: [debug]

  
  resources:
    limits:
      cpu: 500m
      memory: 1024Mi
    requests:
      cpu: 500m
      memory: 1024Mi

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector-daemonset
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-collector-daemonset
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["replicasets", "deployments", "daemonsets", "statefulsets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources: ["replicasets", "deployments", "daemonsets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/status"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-collector-daemonset
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-collector-daemonset
subjects:
  - kind: ServiceAccount
    name: otel-collector-daemonset
    namespace: monitoring